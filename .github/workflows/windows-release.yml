name: Build & Release SeqEyes (Windows)

on:
  push:
    tags:
      - 'v*'          # v1.0.0 → versioned release
    branches:
      - main          # main → latest release
      - dev           # dev → build check (artifact only)
    paths-ignore:
      - '**.md'
      - 'doc/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:      

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ---- Qt ----
    - name: Install Qt 6.5.3 (MSVC 2019)
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.3'
        arch: 'win64_msvc2019_64'
        cache: true

    # ---- MSVC ----
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    # ---- sccache ----
    - name: Setup sccache
      uses: mozilla-actions/sccache-action@v0.0.4

    # ---- Build ----
    - name: Configure (CMake)
      run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

    - name: Build
      run: cmake --build build --config Release

    - name: Print sccache stats
      run: sccache --show-stats

    # ---- Deploy Qt ----
    - name: Run windeployqt
      run: |
        cd build/Release
        windeployqt seqeyes.exe

    # ---- Test ----
    - name: Run Headless Load Test
      run: python test/test_load_all.py --bin-dir build/Release

    - name: Run Performance Test
      run: |
        # Ensure bin-dir points to build/Release
        python test/test_perf_zoom.py --bin-dir build/Release --github-benchmark-out test/perf_bench.json --repeat 5 --warmup

    - name: Store Benchmark Results
      uses: benchmark-action/github-action-benchmark@v1
      with:
        name: SeqEyes Zoom Performance
        tool: 'customGeneric'
        output-file-path: test/perf_bench.json
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: true
        # Performance regression alert
        alert-threshold: '120%'
        comment-on-alert: true
        fail-on-alert: true
        # Store in gh-pages branch
        gh-pages-branch: gh-pages
        benchmark-data-dir-path: dev/benchmarks

    # ---- Prepare package ----
    - name: Prepare package folder
      run: |
        mkdir package
        xcopy build\Release package\seqeyes /E /I

    - name: Create ZIP
      shell: pwsh
      run: |
        if ("${{ github.ref }}" -match "refs/tags/") {
          # Tag push → versioned release ZIP
          $zipName = "seqeyes-${{ github.ref_name }}-win64.zip"
        } else {
          # Non-tag push → always latest
          $zipName = "seqeyes-latest-win64.zip"
        }
        Compress-Archive -Path package\seqeyes -DestinationPath "$zipName"

    # ---- Upload to Release (only for tags) ----
    - name: Upload to GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: seqeyes-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ---- Upload latest artifact (only for non-tags) ----
    - name: Upload latest artifact
      if: github.ref_type != 'tag'
      uses: actions/upload-artifact@v6
      with:
        name: seqeyes-latest-win64       # artifact name always "latest"

        path: seqeyes-latest-win64.zip   # path to zip
