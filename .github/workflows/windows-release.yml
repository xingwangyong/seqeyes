name: Build & Release SeqEyes (Windows)

on:
  push:
    tags:
      - 'v*'          # v1.0.0 -> versioned release
    branches:
      - main
      - dev
      - feature/*
      - fix/*
      - test/*
    paths-ignore:
      - '**.md'
      - 'doc/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:

jobs:
  build_runtime:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ---- Qt ----
    - name: Install Qt 6.5.3 (MSVC 2019)
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.3'
        arch: 'win64_msvc2019_64'
        cache: true

    # ---- MSVC ----
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    # ---- sccache ----
    - name: Setup sccache
      uses: mozilla-actions/sccache-action@v0.0.9
      with:
        version: "v0.10.0"

    # ---- Build ----
    - name: Configure (CMake)
      env:
        SCCACHE_GHA_ENABLED: "true"
      run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache -DCMAKE_MSVC_DEBUG_INFORMATION_FORMAT=Embedded

    - name: Build
      env:
        SCCACHE_GHA_ENABLED: "true"
      run: cmake --build build --config Release

    - name: Print sccache stats
      run: sccache --show-stats

    # ---- Deploy Qt ----
    - name: Run windeployqt
      run: |
        cd build
        windeployqt seqeyes.exe

    # Prepare a reusable runtime zip for parallel test jobs.
    - name: Pack Runtime Zip
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Path runtime -Force | Out-Null
        xcopy build runtime\seqeyes /E /I
        Compress-Archive -Path runtime\seqeyes -DestinationPath seqeyes-ci-runtime.zip

    - name: Upload Runtime Zip
      uses: actions/upload-artifact@v4
      with:
        name: seqeyes-ci-runtime
        path: seqeyes-ci-runtime.zip

  visual_regression:
    needs: build_runtime
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download Runtime Zip
      uses: actions/download-artifact@v4
      with:
        name: seqeyes-ci-runtime
        path: .

    - name: Extract Runtime
      shell: pwsh
      run: |
        Expand-Archive -Path seqeyes-ci-runtime.zip -DestinationPath runtime -Force

    - name: Setup Python Dependencies
      run: pip install Pillow gdown pyyaml

    - name: Download Baselines from Google Drive
      env:
        # Baselines in this folder are expected to be generated by
        # .github/workflows/visual-baseline-capture.yml on windows-latest.
        # Hardcoded public folder ID to ensure it works automatically in forks.
        GDRIVE_BASELINE_FOLDER_ID: "1Lhbd8zXQlI6z_o0f6HQPDb1umb_zLush"
      run: |
        mkdir test/baselines -ErrorAction SilentlyContinue
        gdown --folder "https://drive.google.com/drive/folders/$env:GDRIVE_BASELINE_FOLDER_ID" -O test/baselines/

    - name: Run Visual Regression Test
      id: visual_test
      run: |
        python test/test_visual_regression.py --bin-dir runtime/seqeyes --threshold 0.005 --changed-threshold 0.0001

    - name: Upload Visual Diff Artifacts on Failure
      if: failure() && steps.visual_test.outcome == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: visual-regression-diffs
        path: |
          test/snapshots/*.png
          test/baselines/*.png

  headless_load:
    needs: build_runtime
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download Runtime Zip
      uses: actions/download-artifact@v4
      with:
        name: seqeyes-ci-runtime
        path: .

    - name: Extract Runtime
      shell: pwsh
      run: |
        Expand-Archive -Path seqeyes-ci-runtime.zip -DestinationPath runtime -Force

    - name: Run Headless Load Test
      run: python test/test_load_all.py --bin-dir runtime/seqeyes

  performance:
    needs: build_runtime
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download Runtime Zip
      uses: actions/download-artifact@v4
      with:
        name: seqeyes-ci-runtime
        path: .

    - name: Extract Runtime
      shell: pwsh
      run: |
        Expand-Archive -Path seqeyes-ci-runtime.zip -DestinationPath runtime -Force

    - name: Run Performance Test
      run: |
        python test/test_perf_zoom.py --bin-dir runtime/seqeyes --github-benchmark-out test/perf_bench.json --repeat 5 --warmup

    - name: Store Benchmark Results
      # Only push benchmark data to gh-pages if we are on main or dev branches,
      # NOT for pull requests from forks or feature branches.
      if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
      uses: benchmark-action/github-action-benchmark@v1
      with:
        name: SeqEyes Zoom Performance
        tool: 'customSmallerIsBetter'
        output-file-path: test/perf_bench.json
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: true
        # Performance regression alert
        alert-threshold: '120%'
        comment-on-alert: true
        fail-on-alert: true
        # Store in gh-pages branch
        gh-pages-branch: gh-pages
        benchmark-data-dir-path: dev/benchmarks

  package_release:
    needs: [visual_regression, headless_load, performance]
    runs-on: windows-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Download Runtime Zip
      uses: actions/download-artifact@v4
      with:
        name: seqeyes-ci-runtime
        path: .

    - name: Create Final ZIP Name
      shell: pwsh
      run: |
        if ("${{ github.ref }}" -match "refs/tags/") {
          $zipName = "seqeyes-${{ github.ref_name }}-win64.zip"
        } else {
          $zipName = "seqeyes-latest-win64.zip"
        }
        Copy-Item -Path seqeyes-ci-runtime.zip -Destination $zipName -Force

    # ---- Upload to Release (only for tags) ----
    - name: Upload to GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: seqeyes-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ---- Upload latest artifact (only for non-tags) ----
    - name: Upload latest artifact
      if: github.ref_type != 'tag'
      uses: actions/upload-artifact@v6
      with:
        name: seqeyes-latest-win64
        path: seqeyes-latest-win64.zip

  cleanup_internal_artifacts:
    if: ${{ always() }}
    needs: [build_runtime, visual_regression, headless_load, performance, package_release]
    runs-on: windows-latest
    permissions:
      actions: write
      contents: read

    steps:
    - name: Delete Internal Runtime Artifact
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $repo = "${{ github.repository }}"
        $runId = "${{ github.run_id }}"
        $ids = gh api "repos/$repo/actions/runs/$runId/artifacts" --paginate --jq '.artifacts[] | select(.name=="seqeyes-ci-runtime") | .id'
        if (-not $ids) {
          Write-Host "No internal runtime artifact found to delete."
          exit 0
        }
        foreach ($id in $ids) {
          gh api -X DELETE "repos/$repo/actions/artifacts/$id"
          Write-Host "Deleted internal artifact id=$id"
        }
