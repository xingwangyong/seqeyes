name: Build & Release SeqEyes (Windows)

on:
  push:
    tags:
      - 'v*'          # v1.0.0 → versioned release
    branches:
      - main          
      - dev          
      - feature/*     
      - fix/*         
      - test/*        
    paths-ignore:
      - '**.md'
      - 'doc/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:
    inputs:
      baseline_only:
        description: "Only generate visual baselines and upload artifact"
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ---- Qt ----
    - name: Install Qt 6.5.3 (MSVC 2019)
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.3'
        arch: 'win64_msvc2019_64'
        cache: true

    # ---- MSVC ----
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1


    # ---- sccache ----
    - name: Setup sccache
      uses: mozilla-actions/sccache-action@v0.0.9
      with:
        version: "v0.10.0"

    # ---- Build ----
    - name: Configure (CMake)
      env:
        SCCACHE_GHA_ENABLED: "true"
      run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache -DCMAKE_MSVC_DEBUG_INFORMATION_FORMAT=Embedded

    - name: Build
      env:
        SCCACHE_GHA_ENABLED: "true"
      run: cmake --build build --config Release

    - name: Print sccache stats
      run: sccache --show-stats

    # ---- Deploy Qt ----
    - name: Run windeployqt
      run: |
        cd build
        windeployqt seqeyes.exe

    - name: Setup Python Dependencies for Visual Tests
      run: pip install Pillow gdown pyyaml

    # ---- Baseline Capture Only (manual mode) ----
    - name: Generate Baselines (baseline_only mode)
      if: ${{ github.event_name == 'workflow_dispatch' && inputs.baseline_only }}
      run: |
        python test/generate_baselines_batch.py --seq-dir test/seq_files --bin-dir build --out-dir test/baselines

    - name: Upload Baseline Artifact (baseline_only mode)
      if: ${{ github.event_name == 'workflow_dispatch' && inputs.baseline_only }}
      uses: actions/upload-artifact@v4
      with:
        name: visual-baselines-windows-latest
        path: test/baselines/*.png

    # ---- Visual Regression (Google Drive Baselines generated on windows-latest CI) ----
    - name: Download Baselines from Google Drive
      if: ${{ github.event_name != 'workflow_dispatch' || !inputs.baseline_only }}
      env:
        # Baselines in this folder are expected to be generated by this workflow
        # on windows-latest with workflow_dispatch + baseline_only=true.
        # Hardcoded public folder ID to ensure it works automatically in forks.
        GDRIVE_BASELINE_FOLDER_ID: "1Lhbd8zXQlI6z_o0f6HQPDb1umb_zLush"
      run: |
        mkdir test/baselines -ErrorAction SilentlyContinue
        gdown --folder "https://drive.google.com/drive/folders/$env:GDRIVE_BASELINE_FOLDER_ID" -O test/baselines/

    - name: Run Visual Regression Test
      if: ${{ github.event_name != 'workflow_dispatch' || !inputs.baseline_only }}
      id: visual_test
      run: |
        python test/test_visual_regression.py --bin-dir build --threshold 0.005

    - name: Upload Visual Diff Artifacts on Failure
      if: ${{ (github.event_name != 'workflow_dispatch' || !inputs.baseline_only) && failure() && steps.visual_test.outcome == 'failure' }}
      uses: actions/upload-artifact@v4
      with:
        name: visual-regression-diffs
        path: |
          test/snapshots/*.png
          test/baselines/*.png

    # ---- Test (Other) ----
    - name: Run Headless Load Test
      if: ${{ github.event_name != 'workflow_dispatch' || !inputs.baseline_only }}
      run: python test/test_load_all.py --bin-dir build

    - name: Run Performance Test
      if: ${{ github.event_name != 'workflow_dispatch' || !inputs.baseline_only }}
      # Skip if this is a PR that doesn't target main/dev (though our workflow triggers only on main/dev PRs)
      # Or you can just run it to let PR authors see their performance impact in the console.
      run: |
        # Ensure bin-dir points to build
        python test/test_perf_zoom.py --bin-dir build --github-benchmark-out test/perf_bench.json --repeat 5 --warmup

    - name: Store Benchmark Results
      # Only push benchmark data to gh-pages if we are on main or dev branches,
      # NOT for pull requests from forks or feature branches.
      if: ${{ (github.event_name != 'workflow_dispatch' || !inputs.baseline_only) && github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') }}
      uses: benchmark-action/github-action-benchmark@v1
      with:
        name: SeqEyes Zoom Performance
        tool: 'customSmallerIsBetter'
        output-file-path: test/perf_bench.json
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: true
        # Performance regression alert
        alert-threshold: '120%'
        comment-on-alert: true
        fail-on-alert: true
        # Store in gh-pages branch
        gh-pages-branch: gh-pages
        benchmark-data-dir-path: dev/benchmarks

    # ---- Prepare package ----
    - name: Prepare package folder
      if: ${{ github.event_name != 'workflow_dispatch' || !inputs.baseline_only }}
      run: |
        mkdir package
        xcopy build package\seqeyes /E /I

    - name: Create ZIP
      if: ${{ github.event_name != 'workflow_dispatch' || !inputs.baseline_only }}
      shell: pwsh
      run: |
        if ("${{ github.ref }}" -match "refs/tags/") {
          # Tag push → versioned release ZIP
          $zipName = "seqeyes-${{ github.ref_name }}-win64.zip"
        } else {
          # Non-tag push → always latest
          $zipName = "seqeyes-latest-win64.zip"
        }
        Compress-Archive -Path package\seqeyes -DestinationPath "$zipName"

    # ---- Upload to Release (only for tags) ----
    - name: Upload to GitHub Release
      if: ${{ (github.event_name != 'workflow_dispatch' || !inputs.baseline_only) && startsWith(github.ref, 'refs/tags/') }}
      uses: softprops/action-gh-release@v1
      with:
        files: seqeyes-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # ---- Upload latest artifact (only for non-tags) ----
    - name: Upload latest artifact
      if: ${{ (github.event_name != 'workflow_dispatch' || !inputs.baseline_only) && github.ref_type != 'tag' }}
      uses: actions/upload-artifact@v6
      with:
        name: seqeyes-latest-win64       # artifact name always "latest"

        path: seqeyes-latest-win64.zip   # path to zip
