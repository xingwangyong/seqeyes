name: Python Publish

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-wheels:
    name: Build wheel on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            qt_arch: win64_msvc2019_64
          - os: macos-latest
            qt_arch: clang_64
          - os: ubuntu-latest
            qt_arch: gcc_64

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---- Qt ----
      - name: Install Qt 6.5.3
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          arch: ${{ matrix.qt_arch }}
          cache: true

      # ---- Set Qt environment variables (macOS only, for delocate) ----
      # Derive QT_ROOT_DIR from QML2_IMPORT_PATH since install-qt-action may
      # not export QT_ROOT_DIR reliably in all cache/version combinations.
      - name: Set Qt environment for macOS
        if: runner.os == 'macOS'
        run: |
          if [ -n "${QML2_IMPORT_PATH}" ]; then
            QT_ROOT="${QML2_IMPORT_PATH%/qml}"
          else
            QT_ROOT="$(qmake -query QT_INSTALL_PREFIX)"
          fi
          echo "QT_ROOT_DIR=${QT_ROOT}" >> $GITHUB_ENV
          echo "DYLD_LIBRARY_PATH=${QT_ROOT}/lib:${DYLD_LIBRARY_PATH}" >> $GITHUB_ENV
          echo "QT_PLUGIN_PATH=${QT_ROOT}/plugins:${QT_PLUGIN_PATH}" >> $GITHUB_ENV

      # ---- MSVC (Windows only) ----
      - name: Setup MSVC
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      # ---- Clean stale build artifacts (prevents moc version mismatch) ----
      - name: Clean build directories
        shell: bash
        run: rm -rf _cmake_build seqeyes_autogen

      # ---- Build & install the seqeyes C++ binary into python/seqeyes/bin/ ----
      - name: Configure (CMake)
        run: >
          cmake -S . -B _cmake_build
          -DCMAKE_BUILD_TYPE=Release
          -DSEQEYES_BUILD_TESTS=OFF
          -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/python"

      - name: Build (CMake)
        run: cmake --build _cmake_build --config Release

      - name: Install binary into package tree
        run: cmake --install _cmake_build --config Release

      # ---- Copy Qt frameworks so delocate can bundle them into the wheel ----
      # The seqeyes binary's RPATH is set to @executable_path/QtFrameworks,
      # so delocate resolves Qt*.framework dependencies from that subdirectory.
      - name: Copy Qt frameworks for macOS wheel
        if: runner.os == 'macOS'
        run: |
          QT_FW_DST="${{ github.workspace }}/python/seqeyes/bin/QtFrameworks"
          mkdir -p "${QT_FW_DST}"
          for fw in QtCore QtGui QtWidgets QtPrintSupport; do
            cp -R "${QT_ROOT_DIR}/lib/${fw}.framework" "${QT_FW_DST}/"
          done
          echo "DYLD_FRAMEWORK_PATH=${QT_FW_DST}:${DYLD_FRAMEWORK_PATH}" >> $GITHUB_ENV

      # ---- Build Python wheel (pure setuptools, binary now present) ----
      - name: Build wheel
        run: |
          pip install build
          python -m build --wheel --outdir wheelhouse

      # ---- Repair wheel: bundle Qt shared libraries ----
      - name: Repair wheel (Linux – auditwheel)
        if: runner.os == 'Linux'
        run: |
          pip install auditwheel
          auditwheel repair wheelhouse/*.whl -w dist/

      - name: Repair wheel (macOS – delocate)
        if: runner.os == 'macOS'
        run: |
          pip install delocate
          delocate-wheel -w dist/ wheelhouse/*.whl

      - name: Copy wheel (Windows – windeployqt already ran via cmake install)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Copy-Item wheelhouse\*.whl dist\

      # ---- Upload ----
      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: dist/*.whl

  publish:
    name: Publish to PyPI
    needs: build-wheels
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/project/seqeyes/
    permissions:
      id-token: write

    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist/
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          # TODO: finalize by parent repo owner – configure PyPI trusted publisher
          # or set the PYPI_API_TOKEN secret in repo settings.
          # password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
